name: Fix Model Path

on:
  push:
    branches:
      - main

permissions:
  contents: write  # Needed to create commits

jobs:
  fix-paths:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history to compare commits
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get changed files
        id: changed-files
        run: |
          BASE_SHA="${{ github.event.before }}"
          HEAD_SHA="${{ github.sha }}"
          echo "base=$BASE_SHA" >> $GITHUB_OUTPUT
          echo "head=$HEAD_SHA" >> $GITHUB_OUTPUT

      - name: Find and fix model paths
        id: fix-paths
        run: |
          BASE_SHA="${{ steps.changed-files.outputs.base }}"
          HEAD_SHA="${{ steps.changed-files.outputs.head }}"
          
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACM "$BASE_SHA" "$HEAD_SHA" || echo "")
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No changed files found"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Add rewrite rules here (easy to extend later):
          # - Each rule is: 'PATTERN|||REPLACEMENT' for sed -E s|PATTERN|REPLACEMENT|g
          REWRITE_RULES=(
            '/share/public/public_models/(Qwen3-[^"'"'"'[:space:]\)\],}]+)|||Qwen/\1'
          )
          OLD_ROOT="/share/public/public_models/"
          
          # Check if any files contain the old path pattern
          FILES_TO_FIX=""
          while IFS= read -r file; do
            if [ -f "$file" ] && grep -q "$OLD_ROOT" "$file" 2>/dev/null; then
              FILES_TO_FIX="$FILES_TO_FIX $file"
            fi
          done <<< "$CHANGED_FILES"
          
          if [ -z "$FILES_TO_FIX" ]; then
            echo "No files need fixing"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Fix the paths in all matching files
          FIXED_FILES=""
          for file in $FILES_TO_FIX; do
            if [ -f "$file" ]; then
              for rule in "${REWRITE_RULES[@]}"; do
                PATTERN="${rule%%|||*}"
                REPLACEMENT="${rule#*|||}"
                sed -i -E "s|$PATTERN|$REPLACEMENT|g" "$file"
              done
              git add "$file"
            fi
          done

          # Only claim changes if something is actually staged
          if git diff --cached --quiet; then
            echo "No effective changes after replacement"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Report which files were actually modified (best-effort)
          while IFS= read -r f; do
            FIXED_FILES="$FIXED_FILES\n  - $f"
          done <<< "$(git diff --cached --name-only)"

          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "fixed_files<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FIXED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Commit and push fixes
        if: steps.fix-paths.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -m "fix: Update Qwen3 model paths

          Replace /share/public/public_models/Qwen3-* with Qwen/Qwen3-*"
          git push

